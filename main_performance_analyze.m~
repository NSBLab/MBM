%              ********************************************
%         ********************************************************
%         *               Mode-based Morphometry                 *
%         *                       Trang Cao                      *
%         *           Neural Systems and Behaviour Lab           *
%         *                   Monash University                  *
%         *                         2022                         *
%         ********************************************************
%% ---------------------------<< INTRODUCTION >>---------------------------
%Analysing performances of SBM and MBM in terms of accuracy and consistency

%% --------------------------<< INITIALIZATION >>--------------------------
clear all
close all

%% read EM
addpath('/home/trangc/kg98/trangc/library')
addpath('/fs02/kg98/trangc/library/gifti-matlab')

N_v = 32492;%number of vertices of a hemisphere
N_m = 29696;%number of vertices without the middle wall

N_sub = 50;%No of subjects
N_p = N_sub/2;%No of patients
N_c = N_p;%No of controls

N_EM = 150;%No of EM

dM = flip(0.2:0.2:1);%[1, 0.3, 0.2, 0.1]; %coefficient of group map
dN = 0:0.2:1;%[0, 0.1, 0.2, 0.6, 1]; %coefficient of noise
N_M = length(dM);
N_N = length(dN);

N_s = 100; %No of simulation

in_GT = 1;  %index of ground truth

smoothsize= 0;  %FWHM (mm)

if smoothsize == 0
    filename = 'lh.thickness.fsLR_32k.func.gii'; %part of name of generated map
else
    filename = ['lh.thickness_fwhm_',num2str(smoothsize),'mm.32k_fs_LR.shape.gii'];
end

thres = 0.05;

mask = dlmread('mask_S1200.L.midthickness_MSMAll.32k_fs_LR.txt');   %mask to remove the middle wall using Human.MedialWall_Conte69.32k_fs_LR.dlabel.nii
%% read GT
sub = dlmread('/fs02/kg98/trangc/HCP339independent/sub_ID.txt');
load(['/home/trangc/kg98/trangc/eig_sim/gen_map_full_offset_1min_',num2str(in_GT),'_smooth_',num2str(smoothsize),...
    'mm/ground_truth_indices_Nsub_',num2str(N_sub),'.mat'],'in_p','in_c');

%% read EM
load(['evec_',num2str(N_EM),'_norm_with_const_mode_masked_S1200.L.midthickness_MSMAll.32k_fs_LR.mat'],'eig');    %read EMs that are calculated from the midthickness surface of 32k HCP and then z-scored

%% read grouth truth maps 
p_gifti  =gifti(['/fs02/kg98/trangc/HCP339independent/',num2str(sub(in_p)),'/T1w/',num2str(sub(in_p)),'/surf/',filename]);
indicatorMatrix(1,:) = p_gifti.cdata;%patient group
p_gifti = gifti(['/fs02/kg98/trangc/HCP339independent/',num2str(sub(in_c)),'/T1w/',num2str(sub(in_c)),'/surf/',filename]);
indicatorMatrix(2,:) = p_gifti.cdata;%control group

indicatorMatrix = indicatorMatrix(:,mask==1);%remove the middle wall

G_dif = indicatorMatrix(1,:)-indicatorMatrix(2,:);%ground truth difference

beta_G = ((eig.'*eig)\(eig.'*(G_dif)'))';%beta spectrum of the ground truth

%% run ana
null_test_dir = ['/fs02/kg98/trangc/eig_sim/null_test_full_offset_1min_with_norm_const_mode_inGT_',num2str(in_GT),...
    '_smooth_',num2str(smoothsize),'mm/eig_sim_null_test_smooth_',num2str(smoothsize),...
    'mm_NEM_',num2str(N_EM)];

for i1 = 1:N_M
    for i2 = 1:N_N
        [N_fi(i1,i2), beta_co_mean(i1,i2), tmap_co_mean(i1,i2),  tmap_pair_mean(i1,i2), beta_pair_mean(i1,i2),...
            r_tmap_pair_mean(i1,i2), r_beta_pair_mean(i1,i2), tmap_dis(i1,i2,:), tmap_edge(i1,i2,:),...
            beta_dis(i1,i2,:), beta_edge(i1,i2,:), r_phi_dis(i1,i2,:), r_phi_edge(i1,i2,:), ...
            sign_ra_dis(i1,i2,:), sign_ra_edge(i1,i2,:)] = ana_ex(null_test_dir,N_sub,sub,dM(i1),dN(i2),...
            N_m,N_p,N_c,N_EM,mask,N_M,N_N,thres,G_dif,beta_G,smoothsize,in_GT)     ;
    end
end
save('simu_full_offset_1min_para_norm.mat','N_fi', 'beta_co_mean', 'tmap_co_mean',  'tmap_pair_mean', 'beta_pair_mean',...
    'r_tmap_pair_mean', 'r_beta_pair_mean', 'tmap_dis', 'tmap_edge',...
    'beta_dis', 'beta_edge', 'r_phi_dis', 'r_phi_edge', ...
    'sign_ra_dis', 'sign_ra_edge');



%%%%%%%%%%%
function [N_f,beta_co_mean,tmap_co_mean,tmap_pair_mean, beta_pair_mean, r_tmap_pair_mean, r_beta_pair_mean,...
    tmap_dis, tmap_edge, beta_dis, beta_edge, r_phi_dis, r_phi_edge, sign_ra_dis, sign_ra_edge]...
    =ana_ex(null_test,N_sub,sub,dM,dN,N_m,N_p,N_c,N_EM,mask,N_M,N_N,thres,G_dif,beta_G,smoothsize,in_GT)

all_sim = dir([null_test,'_Nsub_',num2str(N_sub),'_dM_',num2str(dM),'_dN_',num2str(dN),...
    '_*','.mat']); %all simulation results for each pair of dM and dN
N_f = size(all_sim,1);

%% read t-maps and beta spectrum and their p-values.
for i=1:N_f
    load(['/fs02/kg98/trangc/eig_sim/null_test_full_offset_1min_with_norm_const_mode_inGT_',num2str(in_GT),...
        '_smooth_',num2str(smoothsize),'mm/',all_sim(i).name],'beta_zsc','thick_t','pBeta','p_tmap');
    
    %correlation
    beta_co(i) = corr(beta_zsc',beta_G');
    tco_m(i) = corr(G_dif',thick_t');
    
    thick_test(i,:) = thick_t;
    beta_ex(i,:) = beta_zsc(1,:);
    
    p_eig(i,:) = pBeta;
    p_vbm(i,:) = p_tmap;
    i
end

%% mean correlation
beta_co_mean = mean(beta_co);
% beta_co_mean = mean(beta_co(~isnan(beta_co)));
% beta_co_var = var(beta_co(~isnan(beta_co)));
% beta_co_min = min(beta_co(~isnan(beta_co)));
% beta_co_max = max(beta_co(~isnan(beta_co)));
%
tmap_co_mean = mean(tco_m);
%tco_var = max(var(tco_v));
%tmap_co_mean = mean(tmap_co(~isnan(tmap_co)));
%tmap_co_var = var(tmap_co(~isnan(tmap_co)));
%tmap_co_min = min(tmap_co(~isnan(tmap_co)));
%tmap_co_max = max(tmap_co(~isnan(tmap_co)));
%

%% correlation distribution of unthresholded results
tmap_cor2 = corr(thick_test',thick_test');
tmap_tril = tmap_cor2(find(tril(tmap_cor2,-1)));
tmap_his = histogram(tmap_tril,'Normalization','pdf');
tmap_dis = {tmap_his.Values};
tmap_edge = {tmap_his.BinEdges(1:(length(tmap_his.BinEdges)-1))};
%
beta_cor2 = corr(beta_ex',beta_ex');
beta_tril = beta_cor2(find(tril(beta_cor2,-1)));
beta_his = histogram(beta_tril,'Normalization','pdf');
beta_dis = {beta_his.Values};
beta_edge = {beta_his.BinEdges(1:(length(beta_his.BinEdges)-1))};

%% correlation distribution of thresholded results
thick_thres = p_vbm<=thres;
r_phi_tmap = Bin_corr(thick_thres,N_f,N_m);
r_phi_his = histogram(r_phi_tmap,'Normalization','pdf');%,'BinWidth',0.01);
% r_phi_tmap_mean = mean(r_phi_tmap,1);
% r_phi_his = histogram(r_phi_tmap_mean,'Normalization','pdf');%,'BinWidth',0.01);
r_phi_dis = {r_phi_his.Values};
r_phi_edge = {r_phi_his.BinEdges(1:(length(r_phi_his.BinEdges)-1))};
%
beta_thres = p_eig<=thres;
r_phi_pval = Bin_corr(beta_thres,N_f,N_EM);
sign_ra_his = histogram(r_phi_pval,'Normalization','pdf');
sign_ra_dis = {sign_ra_his.Values};
sign_ra_edge = {sign_ra_his.BinEdges(1:(length(sign_ra_his.BinEdges)-1))};

tmap_pair_mean = mean(tmap_tril);
beta_pair_mean = mean(beta_tril);
r_tmap_pair_mean = mean(r_phi_tmap);
r_beta_pair_mean = mean(r_phi_pval);

end




